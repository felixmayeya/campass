define(["text!/tpl/search.html","serchCharts","icheck"],function(t){function e(){function e(t,e,i,d,c){if(void 0==r||0==s||0==dataID.length)return swal({title:Dynamic.search_select,confirmButtonText:Dynamic.search_ok}),!1;var l="";l=""===c?t:c+","+t;var p=s+l+d;if(o.indexOf(p)!=-1)return setTimeout(function(){swal({title:Dynamic.search_sl_feat,confirmButtonText:Dynamic.search_ok})},10),!1;$("#txt").blur(),$("#append").hide().html(""),$(".serchE").prop("disabled",!1),$("#createmission").prop("disabled",!1),$("body").css("overflow-y","scroll"),$(".box2").show(),n=echarts.init(document.getElementById("loadbox")),n.showLoading({text:"loading",color:"#678098",textColor:"#678098",maskColor:"rgba(255, 255, 255, 0.8)",zlevel:0}),6==$(".znss2-rightH div").length&&($(".znss2-rightH>div:first-of-type").remove(),$(".znss2-rightM>div:nth-of-type(1),.znss2-rightM>div:nth-of-type(2)").remove(),o.shift());var h={},m=$(".tabinfo div").clone(),f=$(".tableinfo .tablex").clone(),u=$(".tableinfo .end_znss1").clone();m.find("span").html(s+l+d),m.find("b").html(l),m.attr({title:Dynamic.search_project+r+"\n"+Dynamic.search_keyword+l+"\n"+Dynamic.search_time+d,name:l,"data-pid":s,"data-pname":r,"data-start":e,"data-end":i}),u.attr("name",s+l+d),f.find(".tableSave").bind("click",a),o.push(p),$(".znss2-rightH div").attr("class","qhfalse"),$(".znss2-rightH").append(m),$(".znss2-rightM").append(u),$(".znss2-rightM").append(f),$(".end_znss1").hide(),$(".tablex").hide(),$(".region-select").undelegate(),$(".region-select").delegate("a","click",function(){var t=$(".qhtrue",$(this).parents(".znss2-rightM").prev()).attr("name"),a=$(this).attr("data-value"),n={start_time:e,end_time:i,fid:dataID,product:"campass",project_id:s,txt:t,country:"World"===a?"":"China",timezone:timeZone},o=$(this).parents(".searchCountrySelect").prev()[0],r=echarts.init(o);r.showLoading(loadingObj),$(".searchCountrySelect").css("display","none"),registMap(a),$.ajax({type:"GET",async:!0,url:"/api/serch.open?cmd=WEL:CHINESEANDENGLIShHMAP",cache:!1,data:n,dataType:"json",success:function(t){for(var e=[],n=0;n<t.city.length;n++)e.push(t.city[n].value);var r=Math.max.apply(null,e);r=0==r?1e3:Math.max.apply(null,e);var s={city:t.city,pre_max:r};echartsInit2(s,o,a)}})}),setTimeout(function(){f.find(".tableSort").dataTable({language:Lang,autoWidth:!1,paging:!0,lengthChange:!0,searching:!1,ordering:!1,processing:!0,serverSide:!0,pagingType:"full_numbers",deferRender:!0,ajax:function(t,a,n){var o={start_time:e,end_time:i,fid:dataID,limit:t.length,page:t.start/t.length+1,product:"campass",project_id:s,txt:l,country:"World"==mapType?"":mapType,timezone:timeZone};$.ajax({type:"GET",async:!0,url:"/api/serch.open",cache:!1,data:o,dataType:"json",success:function(e){var n={};n.draw=t.draw,n.recordsTotal=e.total,n.recordsFiltered=e.total,n.data=e.data,n.charts1=e.percent,n.charts2=e.order,n.charts3=e.city,a(n)}})},columns:[{data:"order"},{data:"datatime"},{data:"message",render:function(t){var e=$(".contentDiv").width()-300,a='<i class="shou_fang"></i><div class="topIp topIp_hide" style="width:'+e+'px"><div class="topIpdiv topIpdiv_hide">'+t+"</div></div>";return a}}],initComplete:function(t,e){$("tr>td:last-of-type").css("padding","8px 0"),h={percent:e.charts1,order:e.charts2,city:e.charts3};var a,o;$(window).width()<970?(a=$(".contentDiv").width()-50,o=$(".contentDiv").width()-50):(a=.6*$(".contentDiv").width(),o=.4*$(".contentDiv").width()),$(".chart1").width(a),$(".chart2").width(o);for(var r=h.city,i=[],c=0;c<r.length;c++)i.push(r[c].value);var p=Math.max.apply(null,i);p=0==p?1e3:Math.max.apply(null,i);var m=document.getElementsByName(s+l+d)[0].childNodes[1].childNodes[1].childNodes[1],v=document.getElementsByName(s+l+d)[0].childNodes[1].childNodes[3].childNodes[1],y={percent:h.percent,order:h.order,city:r,pre_max:p};echartsInit1(y,m),echartsInit2(y,v),u.fadeIn(350),f.fadeIn(350),n.hideLoading(),$(".box2").hide()}}).api()},100)}function a(){var t={pname:$(".qhtrue").attr("data-pname"),fid:dataID,text:$(".qhtrue").attr("name"),start_time:$(".qhtrue").attr("data-start"),product:"campass",project_id:projectID,end_time:$(".qhtrue").attr("data-end"),os_type:isMac()?"mac":"",timezone:timeZone};$.ajax({async:!0,cache:!1,type:"post",url:"/api/serch.open?cmd=WEL:EXPORTEXCEL",data:t,success:function(t){$("#export_excel").submit()}}),$(this).removeClass("purple"),$(this).prop("disabled","true")}$(".page-content").html(t);var n,o=[],r="";changeLanguage("search");var s=sprojectID;sprojectID="",3==roleType&&(s=projectID);(function(){var t,e,a,n=function(){return 0==moment().weekday()?moment().subtract(7,"d").weekday(1).startOf("day"):moment().weekday(1).startOf("day")}(),o=function(){return 0==moment().weekday()?moment().subtract(7,"d").weekday(1).startOf("day").add(7,"d"):moment().weekday(1).startOf("day").add(7,"d")}(),r=function(){return moment().startOf("day")}(),s=function(){return moment().add(1,"d").startOf("day")}();"zh"==localStorage.getItem("language")?(t={"今日":[moment().startOf("day"),moment().add(1,"d").startOf("day")],"昨日":[moment().subtract("days",1).startOf("day"),moment().startOf("day")],"本周":[n,o],"本月":[moment().startOf("month"),moment().add(1,"M").startOf("month")],"本年":[moment().startOf("year"),moment().add(1,"years").startOf("year")]},e=["今日","昨日","本周","本月","本年"],a={applyLabel:"确定",cancelLabel:"关闭",customRangeLabel:"自定义日期",daysOfWeek:["日","一","二","三","四","五","六"],monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"]}):(t={Today:[moment().startOf("day"),moment().add(1,"d").startOf("day")],Yesterday:[moment().subtract("days",1).startOf("day"),moment().startOf("day")],"This Week":[n,o],"This Month":[moment().startOf("month"),moment().add(1,"M").startOf("month")],"This Year":[moment().startOf("year"),moment().add(1,"years").startOf("year")]},e=["Today","Yesterday","This Week","This Month","This Year","Custom Range"],a={customRangeLabel:"Custom Range"}),$("#reportrange>span").html(e[0]+"&nbsp;"+(new Date).Format("yyyy-MM-dd")+" - "+(new Date).add("d",1).Format("yyyy-MM-dd")),$("#start").html(r.format("YYYY-MM-DD HH:mm:ss")),$("#end").html(s.format("YYYY-MM-DD HH:mm:ss")),$("#reportrange").daterangepicker({ranges:t,startDate:r,endDate:s,locale:a,timePicker:!0,timePicker24Hour:!0},function(t,a,n){t.format("YYYYMMDDHHmm"),a.format("YYYYMMDDHHmm");"自定义日期"==n||"Custom Range"==n?$("#reportrange>span").html(t.format("YYYY-MM-DD HH:mm")+" - "+a.format("YYYY-MM-DD HH:mm")):$("#reportrange>span").html(n+"&nbsp;"+t.format("YYYY-MM-DD")+" - "+a.format("YYYY-MM-DD")),n==e[0]||n==e[1]?interval="day":n==e[2]?interval="week":n==e[3]?interval="oneMonth":n==e[4]&&(interval="year"),$("#start").html(t.format("YYYY-MM-DD HH:mm:ss")),$("#end").html(a.format("YYYY-MM-DD HH:mm:ss"))})})();$("#pro_choose").selectpicker({width:"100px",title:Dynamic.search_select,size:10}),$.ajax({async:!0,type:"post",dataType:"json",url:"/api/project.open?cmd=WEL:GETPROJECTINSTATUSONE",data:{roleId:roleID},success:function(t){if($.each(t,function(t,e){var a=e.fileid,n=$("<option value='"+e.name+"' data-fileid='"+a+"' data-id='"+e.id+"'>"+e.name+"</div>");$("#pro_choose").append(n)}),$("#pro_choose").selectpicker("render"),$("#pro_choose").selectpicker("refresh"),1==$("#pro_choose option").length)return!1;if(s&&""!==s){var a=$("#pro_choose option[data-id='"+s+"']").val();$("#pro_choose").selectpicker("val",a),r=a;var n=$("#pro_choose option[data-id='"+s+"']").attr("data-fileid");dataID=n.split(",")}else{var o=$("#pro_choose option:nth-of-type(2)").val();r=o,$("#pro_choose").selectpicker("val",o);var i=$("#pro_choose option:nth-of-type(2)").attr("data-fileid");dataID=i.split(","),s=$("#pro_choose option:nth-of-type(2)").attr("data-id")}var d=localStorage.getItem("SEARCH_PID"),c=localStorage.getItem("SEARCH_KEY");if(d&&c&&""!==d&&""!==c){localStorage.setItem("SEARCH_PID",""),localStorage.setItem("SEARCH_KEY",""),$("#txt").val(c);var l=$("#pro_choose option[data-id='"+d+"']").val();$("#pro_choose").selectpicker("val",l),r=l;var p=$("#pro_choose option[data-id='"+d+"']").attr("data-fileid");dataID=p.split(",");var h=$("#start").text(),m=$("#end").text(),f=h+"~"+m;e(c,h,m,f,"")}},error:function(){$("#pro_choose").selectpicker({width:"100px",title:Dynamic.search_select,size:10})}}),$.ajax({async:!0,type:"post",url:"/api/serch.open?cmd=WEL:SELECTTERMS",data:{},success:function(t){$.each(t,function(){$(".mid_znssH1Span3").append('<span class="keyword" title="'+this+'">'+this+"</span>")})}}),$(".searchinfo").on("focus",function(){$(".mid_znssHP1 i").css("display","block"),$(".mid_znssHP1 i").on("click",function(){$(".mid_znssHP1 input").val(""),$("#append li").remove(),$("#append").hide(),$(this).hide()})}),$(".searchinfo").on("blur",function(){""===$(".mid_znssHP1 input").val()&&$(".mid_znssHP1 i").hide()}),$(".znss2-rightM").delegate(".shou_fang","click",function(){var t=$(this).next(".topIp");"topIp topIp_hide"==t.attr("class")?(t.attr("class","topIp topIp_show"),$(this).next().children(".topIpdiv").attr("class","topIpdiv topIpdiv_show"),$(this).css("transform","rotate(180deg)")):(t.attr("class","topIp topIp_hide"),$(this).next().children(".topIpdiv").attr("class","topIpdiv topIpdiv_hide"),$(this).css("transform","rotate(0deg)"))}),$(function(){function t(t){var e=jQuery.trim($(t).val());if(""===e)return $("#append").hide().html(""),!1;for(var a="",n=0;n<o.length;n++)o[n].indexOf(e)>=0&&(a=a+"<li class='item'>"+o[n]+"</li>");""!==a?($("#append").show().html(a),$("#append li").on("click",function(){$(".mid_znssHP1 input").val($(this).text()),$("#append").hide().html("")})):$("#append").hide().html("")}function a(t){$(".item").removeClass("addbg"),$(t).addClass("addbg")}function n(t){var e=$(t).text();$("#txt").val(e),$("#txt").blur(),$("#append").hide().html("")}var o=[];$("#txt").on("keyup",function(){$.ajax({url:"/api/serch.open?cmd=WEL:SELECTTERMSLIST",type:"GET",dataType:"json",async:!1,success:function(t){o=t}})}),$(".mid_znssH").click(function(t){t.stopPropagation()}),$("body").not(".mid_znssH").click(function(){$("#txt").blur(),$("#append").hide().html("")}),0==Search&&($("body").bind("keydown",function(t){if("#/search"==location.hash){t=t||window.event;var a=t.which?t.which:t.keyCode;if(38==a&&""!==$("#append").html())r();else if(40==a&&""!==$("#append").html())$("#txt").blur(),$(".item").hasClass("addbg")?s():$(".item").removeClass("addbg").eq(0).addClass("addbg");else if(13==a)if(0!==$(".addbg").length)i();else{var n=$(".searchinfo").val(),o=$("#start").text(),d=$("#end").text(),c=o+"~"+d;if(""===n)return!1;e(n,o,d,c,"")}}}),Search=1);var r=function(){$("#txt").blur(),$("body").css("overflow-y","hidden");var t=$(".addbg").prevAll().length,e=$(".item").length-t;0===t?($(".item").removeClass("addbg").eq($(".item").length-1).addClass("addbg"),$("#append").scrollTop(1e5)):($(".item").removeClass("addbg").eq(t-1).addClass("addbg"),(t+1)%10==1&&(e<10?$("#append").scrollTop($("#append").scrollTop()-30*($(".item").length%10)):$("#append").scrollTop($("#append").scrollTop()-300)))},s=function(){$("body").css("overflow-y","hidden");var t=$(".addbg").prevAll().length;t==$(".item").length-1?($(".item").removeClass("addbg").eq(0).addClass("addbg"),$("#append").scrollTop(0)):$(".item").removeClass("addbg").eq(t+1).addClass("addbg"),(t+1)%10===0&&0!==t&&$("#append").scrollTop($("#append").scrollTop()+300)},i=function(){$("#txt").blur();var t=$(".addbg").text();$("#txt").val(t),$("#append").hide().html(""),$("body").css("overflow-y","scroll")};$("#txt").on("keyup",function(){t($(this))}),$(".item").on("mouseenter",function(){a(this)}),$(".item").on("click",function(){n(this)})}),$("#pro_choose").change(function(){var t=$("#pro_choose").find("option:selected").attr("data-fileid");dataID=t.split(","),s=$("#pro_choose").find("option:selected").attr("data-id"),r=$("#pro_choose").find("option:selected").val(),$(".serchE").prop("disabled",!0)}),$(".mid_znssH1Span3").delegate(".keyword","click",function(){$("#append").hide().html(""),$("#txt").val($(this).html());var t=$(this).html(),a=$("#start").text(),n=$("#end").text(),o=a+"~"+n;e(t,a,n,o,"")}),$(".serchC").click(function(){$("#append").hide().html("");var t=$(".searchinfo").val(),a=$("#start").text(),n=$("#end").text(),o=a+"~"+n;return""===t?(swal({title:Dynamic.search_sl_pleasew,confirmButtonText:Dynamic.search_ok}),!1):void e(t,a,n,o,"")}),$(".serchE").click(function(){$("#append").hide().html("");var t=$(".qhtrue").attr("name");void 0!=t?$(".serchE").prop("disabled",!1):$(".serchE").prop("disabled",!0);var a=$(".searchinfo").val(),n=$(".qhtrue").attr("data-start"),o=$(".qhtrue").attr("data-end"),r=n+"~"+o;return a!=t&&""!==a&&void e(a,n,o,r,t)}),$(".znss2-rightH").delegate("div","click",function(){var t=$(this).find("span").html();$(".znss2-rightH div").attr("class","qhfalse"),$(".end_znss1").hide(),$(".tablex").hide(),$(this).attr("class","qhtrue"),$(".end_znss1:eq("+$.inArray(t,o)+")").show(),$(".tablex:eq("+$.inArray(t,o)+")").show()}),$(".znss2-rightH").delegate("i","click",function(t){t.stopPropagation();var e=$(this).parent().children("span").html();if(1==$(this).parents(".znss2-rightH").find("div").length&&($(".serchE").prop("disabled",!0),$("#createmission").prop("disabled",!0)),$(".end_znss1[name='"+e+"']").remove(),$(".tablex:eq("+$.inArray(e,o)+")").remove(),$(this).parent().remove(),o.splice($.inArray(e,o),1),0===$(".znss2-rightH div.qhtrue").length&&$(".znss2-rightH div").length>0){$(".znss2-rightH div:last-of-type").attr("class","qhtrue");var a=$(".znss2-rightH div:last-of-type").find("span").html();$(".end_znss1:eq("+$.inArray(a,o)+")").show(),$(".tablex:eq("+$.inArray(a,o)+")").show()}}),$("#toEmail").iCheck({checkboxClass:"icheckbox_square-blue",increaseArea:"10%"}),$("#createmission").click(function(){function t(){var t=new Date,e=t.getMonth()+1,a=t.getDate();e>=1&&e<=9&&(e="0"+e),a>=0&&a<=9&&(a="0"+a);var n=t.getFullYear()+"-"+e+"-"+a;return n}$("#pone>span").html($(".qhtrue").attr("name")),$("#ptwo>span").html($(".qhtrue").attr("data-pname")),$("#ptwo>span").attr("data-id",$(".qhtrue").attr("data-pid")),$("#pfive>span").html(t())}),$("#freq1").change(function(){var t=$(this).find("option:selected").val();1==t?$(".frechoose1").attr("max","59"):60==t?$(".frechoose1").attr("max","23"):$(".frechoose1").removeAttr("max")}),$("#freq2").change(function(){var t=$(this).find("option:selected").val();1==t?$(".frechoose2").attr("max","59"):60==t?$(".frechoose2").attr("max","23"):$(".frechoose2").removeAttr("max")}),$(".frechoose1").on("keyup",function(){var t=$("#freq1").find("option:selected").val(),e=$(this).val();1==t&&e>59?$(this).val(59):60==t&&e>23&&$(this).val(23)}),$(".frechoose2").on("keyup",function(){var t=$("#freq2").find("option:selected").val(),e=$(this).val();1==t&&e>59?$(this).val(59):60==t&&e>23&&$(this).val(23)}),$("#toEmail").on("ifChecked",function(){$("#emailadd").prop("readonly",!1),$("#freq3").prop("disabled",!1),$("#threshold").prop("readonly",!1)}),$("#toEmail").on("ifUnchecked",function(){$("#emailadd").prop("readonly",!0),$("#freq3").prop("disabled",!0),$("#threshold").prop("readonly",!0)});var i=Ladda.create(document.getElementById("mission_sumb"));$("#mission_sumb").click(function(){i.start();var t=$(".frechoose1").val()*$("#freq1 option:selected").val(),e=$(".frechoose2").val()*$("#freq2 option:selected").val(),a={project_id:$("#ptwo>span").attr("data-id"),product:"campass",key_word:$("#pone>span").html(),frequency:t,range:e,threshold:$("#threshold").val(),email:$("#emailadd").val(),alarm_exp:$("#freq3 option:selected").val(),time_units:$("#freq1 option:selected").attr("data-unit"),range_units:$("#freq2 option:selected").attr("data-unit")};$.ajax({type:"post",url:"/api/monitortask.open?cmd=WEL:INSERTMONITORTASK",data:a,success:function(t){i.stop(),swal({title:Dynamic.manage_sl_savasuccess,confirmButtonText:Dynamic.home_ok,type:"success"},function(){$("#missionModal").modal("hide")})},error:function(){i.stop(),swal({title:Dynamic.manage_sl_savefalse,confirmButtonText:Dynamic.home_ok,type:"error"})}})}),$(window).resize(function(){$(".topIp").width($(".contentDiv").width()-300),$(window).width()<970?($(".chart1").width($(".contentDiv").width()-50),$(".chart2").width($(".contentDiv").width()-50)):($(".chart1").width(.6*$(".contentDiv").width()),$(".chart2").width(.4*$(".contentDiv").width()))})}return{render:e}});